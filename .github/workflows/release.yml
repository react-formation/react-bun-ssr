name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read
  id-token: write

jobs:
  publish-npm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.10"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Ensure trusted publishing npm version
        run: npm install -g npm@^11.5.1

      - name: Show Node and npm versions
        run: |
          node --version
          npm --version

      - name: Install
        run: bun install --frozen-lockfile

      - name: Resolve release metadata
        id: release_meta
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"

          if [[ "$TAG" =~ ^v([0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            DIST_TAG="rc"
          elif [[ "$TAG" =~ ^v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            DIST_TAG="latest"
          else
            echo "Unsupported release tag format: $TAG" >&2
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "dist_tag=$DIST_TAG" >> "$GITHUB_OUTPUT"

      - name: Apply tag version to package.json
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.release_meta.outputs.version }}"
          node <<'EOF'
          const fs = require("fs");
          const pkg = JSON.parse(fs.readFileSync("package.json", "utf8"));
          pkg.version = process.env.VERSION;
          fs.writeFileSync("package.json", `${JSON.stringify(pkg, null, 2)}\n`);
          EOF
        env:
          VERSION: ${{ steps.release_meta.outputs.version }}

      - name: Show publish version
        run: node -p "JSON.parse(require('fs').readFileSync('package.json', 'utf8')).version"

      - name: Pack dry run
        run: npm pack --dry-run

      - name: Publish to npm
        run: npm publish --access public --tag "${{ steps.release_meta.outputs.dist_tag }}"
        env:
          NODE_AUTH_TOKEN: ""
